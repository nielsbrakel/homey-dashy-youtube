<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    /* ========================
       RESET & BASE
       ======================== */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    .widget {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
      padding: 8px;
    }

    .widget.bg-solid {
      background: var(--homey-background-color);
      border-radius: var(--homey-border-radius-default);
    }

    /* ========================
       SIZE VARIABLES
       ======================== */
    .size-small {
      --time-size: 28px;
      --date-size-sm: 11px;
      --date-size-md: 14px;
      --date-size-lg: 28px;
      --flip-w: 22px;
      --flip-h: 32px;
      --flip-font: 22px;
      --dot-size: 4px;
      --analog-size: 60px;
      --gap: 2px;
    }

    .size-medium {
      --time-size: 42px;
      --date-size-sm: 14px;
      --date-size-md: 18px;
      --date-size-lg: 42px;
      --flip-w: 32px;
      --flip-h: 46px;
      --flip-font: 32px;
      --dot-size: 6px;
      --analog-size: 80px;
      --gap: 4px;
    }

    .size-large {
      --time-size: 56px;
      --date-size-sm: 18px;
      --date-size-md: 24px;
      --date-size-lg: 56px;
      --flip-w: 42px;
      --flip-h: 60px;
      --flip-font: 42px;
      --dot-size: 8px;
      --analog-size: 100px;
      --gap: 6px;
    }

    /* ========================
       COLOR VARIABLES
       ======================== */
    .color-default { --color: var(--homey-text-color); --accent: var(--homey-text-color); }
    .color-blue { --color: var(--homey-color-blue-500); --accent: var(--homey-color-blue-500); }
    .color-green { --color: var(--homey-color-green-500); --accent: var(--homey-color-green-500); }
    .color-orange { --color: var(--homey-color-orange-500); --accent: var(--homey-color-orange-500); }
    .color-red { --color: var(--homey-color-red-500); --accent: var(--homey-color-red-500); }
    .color-cyan { --color: #00bcd4; --accent: #00bcd4; }
    .color-purple { --color: #9c27b0; --accent: #9c27b0; }
    .color-pink { --color: #e91e63; --accent: #e91e63; }
    .color-amber { --color: #ffc107; --accent: #ffc107; }
    .color-gradient { --color: var(--homey-text-color); --accent: var(--homey-color-blue-500); }

    /* ========================
       ALIGNMENT
       ======================== */
    .align-left { align-items: flex-start; text-align: left; }
    .align-center { align-items: center; text-align: center; }
    .align-right { align-items: flex-end; text-align: right; }

    /* ========================
       LAYOUT CONTAINER
       ======================== */
    .display-container {
      display: flex;
      flex-direction: column;
      align-items: inherit;
      gap: var(--gap);
    }

    .display-container.layout-stacked { flex-direction: column; }
    .display-container.layout-stacked-reverse { flex-direction: column-reverse; }
    .display-container.layout-inline,
    .display-container.layout-inline-separator,
    .display-container.layout-inline-dot { 
      flex-direction: row; 
      gap: 12px;
      align-items: center;
    }
    .display-container.layout-compact {
      flex-direction: column;
      gap: 0;
    }
    .layout-compact .date-text {
      font-size: var(--date-size-sm) !important;
      opacity: 0.6 !important;
    }

    .layout-separator {
      opacity: 0.4;
      font-weight: 300;
    }

    /* ========================
       BASE TEXT STYLES
       ======================== */
    .time-text, .date-text {
      line-height: 1.1;
      white-space: nowrap;
    }

    .time-text {
      font-size: var(--time-size);
      color: var(--color);
    }

    .date-text {
      color: var(--color);
      opacity: 0.75;
    }

    .date-size-small .date-text { font-size: var(--date-size-sm); }
    .date-size-medium .date-text { font-size: var(--date-size-md); }
    .date-size-large .date-text { font-size: var(--date-size-lg); opacity: 1; }

    /* Date only mode - always full size */
    .mode-date .date-text {
      font-size: var(--time-size);
      opacity: 1;
    }

    /* ========================
       STYLE: MODERN (default)
       ======================== */
    .style-modern .time-text,
    .style-modern .date-text {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 600;
      letter-spacing: -0.02em;
    }

    /* ========================
       STYLE: MINIMAL
       ======================== */
    .style-minimal .time-text,
    .style-minimal .date-text {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 200;
      letter-spacing: -0.01em;
    }

    /* ========================
       STYLE: BOLD
       ======================== */
    .style-bold .time-text,
    .style-bold .date-text {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 900;
      letter-spacing: -0.03em;
      text-transform: uppercase;
    }

    /* ========================
       STYLE: DIGITAL
       ======================== */
    .style-digital .time-text,
    .style-digital .date-text {
      font-family: 'Courier New', 'Monaco', 'Consolas', monospace;
      font-weight: bold;
      letter-spacing: 0.05em;
    }

    /* ========================
       STYLE: RETRO LCD
       ======================== */
    .style-retro {
      background: linear-gradient(180deg, #9ebe7a 0%, #8fb368 100%) !important;
      border-radius: var(--homey-border-radius-default);
    }

    .style-retro .time-text,
    .style-retro .date-text {
      font-family: 'Courier New', monospace;
      font-weight: bold;
      letter-spacing: 0.08em;
      color: #2d5016 !important;
      opacity: 1 !important;
    }

    /* ========================
       STYLE: NEON
       ======================== */
    .style-neon .time-text,
    .style-neon .date-text {
      font-family: 'Courier New', monospace;
      font-weight: bold;
      color: var(--accent) !important;
      text-shadow: 
        0 0 5px var(--accent),
        0 0 10px var(--accent),
        0 0 20px var(--accent),
        0 0 40px var(--accent);
      opacity: 1 !important;
    }

    /* ========================
       STYLE: OUTLINE
       ======================== */
    .style-outline .time-text,
    .style-outline .date-text {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 900;
      color: transparent !important;
      -webkit-text-stroke: 2px var(--color);
      letter-spacing: 0.02em;
      opacity: 1 !important;
    }

    .style-outline .date-text {
      -webkit-text-stroke-width: 1.5px;
    }

    /* ========================
       STYLE: SHADOW
       ======================== */
    .style-shadow .time-text,
    .style-shadow .date-text {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 700;
      text-shadow: 4px 4px 0 var(--homey-color-mono-300);
    }

    /* ========================
       STYLE: ELEGANT
       ======================== */
    .style-elegant .time-text,
    .style-elegant .date-text {
      font-family: 'Georgia', 'Times New Roman', serif;
      font-weight: 400;
      font-style: italic;
      letter-spacing: 0.03em;
    }

    /* ========================
       GRADIENT TEXT
       ======================== */
    .color-gradient .time-text,
    .color-gradient .date-text {
      background: linear-gradient(
        90deg,
        #ff6b6b,
        #feca57,
        #48dbfb,
        #ff9ff3,
        #54a0ff,
        #5f27cd,
        #ff6b6b
      );
      background-size: 300% 100%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      animation: smoothGradient 8s linear infinite;
    }

    @keyframes smoothGradient {
      0% { background-position: 0% 50%; }
      100% { background-position: 300% 50%; }
    }

    /* ========================
       BLINKING COLON
       ======================== */
    .blink-separator .colon-char {
      animation: colonBlink 1s ease-in-out infinite;
    }

    @keyframes colonBlink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.15; }
    }

    .color-gradient.blink-separator .colon-char {
      animation: colonBlinkGradient 1s ease-in-out infinite;
    }

    @keyframes colonBlinkGradient {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.15; }
    }

    /* ========================
       STYLE: FLIP CLOCK
       ======================== */
    .flip-clock {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .flip-group {
      display: flex;
      gap: 2px;
      background: var(--homey-color-mono-200);
      border-radius: 4px;
      padding: 2px;
    }

    .flip-card {
      position: relative;
      width: var(--flip-w);
      height: var(--flip-h);
      border-radius: 3px;
      perspective: 300px;
    }

    .flip-card .flip-face {
      position: absolute;
      width: 100%;
      height: 50%;
      left: 0;
      overflow: hidden;
      backface-visibility: hidden;
    }

    .flip-card .flip-top {
      top: 0;
      background: linear-gradient(180deg, var(--homey-color-mono-100) 0%, var(--homey-color-mono-150) 100%);
      border-bottom: 1px solid var(--homey-color-mono-300);
      border-radius: 3px 3px 0 0;
      z-index: 2;
    }

    .flip-card .flip-bottom {
      bottom: 0;
      background: linear-gradient(180deg, var(--homey-color-mono-150) 0%, var(--homey-color-mono-200) 100%);
      border-radius: 0 0 3px 3px;
      z-index: 1;
    }

    .flip-card .flip-digit {
      position: absolute;
      width: 100%;
      height: calc(var(--flip-h));
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 700;
      font-size: var(--flip-font);
      color: var(--color);
      line-height: 1;
    }

    .flip-card .flip-top .flip-digit {
      top: 0;
    }

    .flip-card .flip-bottom .flip-digit {
      bottom: 0;
    }

    /* Flip animation panels */
    .flip-card .flip-top-back,
    .flip-card .flip-bottom-back {
      position: absolute;
      width: 100%;
      height: 50%;
      left: 0;
      overflow: hidden;
      backface-visibility: hidden;
      z-index: 3;
    }

    .flip-card .flip-top-back {
      top: 0;
      background: linear-gradient(180deg, var(--homey-color-mono-100) 0%, var(--homey-color-mono-150) 100%);
      border-bottom: 1px solid var(--homey-color-mono-300);
      border-radius: 3px 3px 0 0;
      transform-origin: bottom center;
      transform: rotateX(0deg);
    }

    .flip-card .flip-bottom-back {
      bottom: 0;
      background: linear-gradient(180deg, var(--homey-color-mono-150) 0%, var(--homey-color-mono-200) 100%);
      border-radius: 0 0 3px 3px;
      transform-origin: top center;
      transform: rotateX(90deg);
    }

    .flip-card.flipping .flip-top-back {
      animation: flipTop 0.3s ease-in forwards;
    }

    .flip-card.flipping .flip-bottom-back {
      animation: flipBottom 0.3s 0.15s ease-out forwards;
    }

    @keyframes flipTop {
      0% { transform: rotateX(0deg); }
      100% { transform: rotateX(-90deg); }
    }

    @keyframes flipBottom {
      0% { transform: rotateX(90deg); }
      100% { transform: rotateX(0deg); }
    }

    .flip-clock .flip-sep {
      font-size: calc(var(--flip-font) * 0.8);
      font-weight: bold;
      color: var(--color);
      opacity: 0.5;
      padding: 0 2px;
    }

    .flip-clock .flip-period {
      font-size: calc(var(--flip-font) * 0.4);
      font-weight: 600;
      color: var(--color);
      opacity: 0.6;
      margin-left: 4px;
      align-self: flex-end;
    }

    /* ========================
       STYLE: DOT MATRIX
       ======================== */
    .dots-display {
      display: flex;
      align-items: center;
      gap: calc(var(--dot-size) * 1.5);
    }

    .dot-digit {
      display: grid;
      grid-template-columns: repeat(4, var(--dot-size));
      grid-template-rows: repeat(7, var(--dot-size));
      gap: calc(var(--dot-size) * 0.3);
    }

    .dot {
      width: var(--dot-size);
      height: var(--dot-size);
      border-radius: 50%;
      background: var(--homey-color-mono-300);
      opacity: 0.25;
      transition: all 0.15s ease;
    }

    .dot.on {
      background: var(--accent);
      opacity: 1;
      box-shadow: 0 0 calc(var(--dot-size) * 0.5) var(--accent);
    }

    .dot-colon {
      display: flex;
      flex-direction: column;
      gap: calc(var(--dot-size) * 2);
      padding: 0 calc(var(--dot-size) * 0.5);
    }

    .dot-colon .dot {
      background: var(--accent);
      opacity: 1;
      box-shadow: 0 0 calc(var(--dot-size) * 0.5) var(--accent);
    }

    /* ========================
       ANALOG CLOCK STYLES - FIXED
       ======================== */
    .analog-clock {
      position: relative;
      width: var(--analog-size);
      height: var(--analog-size);
      border-radius: 50%;
      flex-shrink: 0;
    }

    .analog-face {
      position: absolute;
      width: 100%;
      height: 100%;
      top: 0;
      left: 0;
    }

    /* ANALOG: CLASSIC */
    .analog-classic {
      background: var(--homey-color-mono-100);
      border: 3px solid var(--color);
    }

    .analog-classic .analog-marker {
      position: absolute;
      width: 2px;
      height: 6px;
      background: var(--color);
      left: 50%;
      top: 6px;
      margin-left: -1px;
      transform-origin: center calc(var(--analog-size) / 2 - 6px);
    }

    /* ANALOG: MINIMAL */
    .analog-minimal {
      background: transparent;
      border: 2px solid var(--color);
    }

    .analog-minimal .analog-marker {
      position: absolute;
      width: 4px;
      height: 4px;
      background: var(--color);
      border-radius: 50%;
      left: 50%;
      top: 8px;
      margin-left: -2px;
      transform-origin: center calc(var(--analog-size) / 2 - 8px);
    }

    /* ANALOG: ROMAN */
    .analog-roman {
      background: var(--homey-color-mono-100);
      border: 3px solid var(--color);
    }

    .analog-roman .roman-numeral {
      position: absolute;
      font-family: 'Times New Roman', serif;
      font-size: calc(var(--analog-size) * 0.11);
      color: var(--color);
      font-weight: bold;
      text-align: center;
      line-height: 1;
    }

    /* ANALOG: MODERN */
    .analog-modern {
      background: var(--homey-color-mono-100);
      border: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.15);
    }

    .analog-modern .analog-marker {
      position: absolute;
      left: 50%;
      top: 6px;
      margin-left: -1px;
      transform-origin: center calc(var(--analog-size) / 2 - 6px);
    }

    .analog-modern .marker-hour {
      width: 2px;
      height: 6px;
      background: var(--color);
      opacity: 0.3;
    }

    .analog-modern .marker-quarter {
      width: 3px;
      height: 10px;
      background: var(--color);
      opacity: 0.8;
      margin-left: -1.5px;
    }

    /* ANALOG: VINTAGE */
    .analog-vintage {
      background: linear-gradient(180deg, #f5f0e6 0%, #e8dcc8 100%);
      border: 4px solid #8b7355;
      box-shadow: inset 0 0 10px rgba(0,0,0,0.1);
    }

    .analog-vintage .analog-marker {
      position: absolute;
      width: 2px;
      height: 5px;
      background: #5c4a32;
      left: 50%;
      top: 8px;
      margin-left: -1px;
      transform-origin: center calc(var(--analog-size) / 2 - 8px);
    }

    .analog-vintage .hand-hour,
    .analog-vintage .hand-minute {
      background: #3d2b1f !important;
    }

    .analog-vintage .hand-second {
      background: #8b4513 !important;
    }

    /* ANALOG: SWISS RAILWAY */
    .analog-swiss {
      background: #fff;
      border: 3px solid #333;
    }

    .analog-swiss .analog-marker {
      position: absolute;
      left: 50%;
      top: 4px;
      transform-origin: center calc(var(--analog-size) / 2 - 4px);
    }

    .analog-swiss .marker-hour {
      width: 4px;
      height: 10px;
      background: #333;
      border-radius: 1px;
      margin-left: -2px;
    }

    .analog-swiss .marker-minute {
      width: 2px;
      height: 5px;
      background: #333;
      margin-left: -1px;
    }

    .analog-swiss .hand-second {
      background: #ff0000 !important;
    }

    .analog-swiss .hand-second::after {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      width: 6px;
      height: 6px;
      background: #ff0000;
      border-radius: 50%;
    }

    /* ANALOG: HANDS */
    .analog-hand {
      position: absolute;
      left: 50%;
      bottom: 50%;
      transform-origin: bottom center;
      border-radius: 2px;
    }

    .hand-hour {
      width: 4px;
      height: calc(var(--analog-size) * 0.25);
      background: var(--color);
      margin-left: -2px;
    }

    .hand-minute {
      width: 3px;
      height: calc(var(--analog-size) * 0.35);
      background: var(--color);
      margin-left: -1.5px;
    }

    .hand-second {
      width: 2px;
      height: calc(var(--analog-size) * 0.38);
      background: var(--accent);
      margin-left: -1px;
    }

    .analog-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 8px;
      height: 8px;
      background: var(--color);
      border-radius: 50%;
      z-index: 10;
    }

    .analog-swiss .analog-center {
      background: #333;
    }

    .analog-vintage .analog-center {
      background: #5c4a32;
    }

    /* ========================
       HYBRID: ANALOG + DIGITAL
       ======================== */
    .hybrid-clock {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .hybrid-clock .time-text {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      font-weight: 600;
      font-size: var(--time-size);
      color: var(--color);
    }

    .hybrid-clock .analog-clock {
      --analog-size: calc(var(--time-size) * 1.4);
    }

    /* Hybrid style for digital with analog seconds */
    .style-hybrid .hybrid-clock .analog-clock {
      border-width: 2px;
    }

    .style-hybrid .hybrid-clock .hand-second {
      width: 2px;
      height: calc(var(--analog-size) * 0.4);
    }

    .style-hybrid .hybrid-clock .analog-center {
      width: 6px;
      height: 6px;
    }

    /* Analog-Digital combo styles */
    .style-analog-digital .hybrid-clock {
      gap: 16px;
    }
  </style>
</head>
<body>
  <div class="widget" id="widget">
    <div id="display"></div>
  </div>

  <script>
    // ========================
    // DATA
    // ========================
    const DIGIT_PATTERNS = {
      '0': [0,1,1,0,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,1,0,0,1,0,1,1,0],
      '1': [0,0,1,0,0,1,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,1,1,1],
      '2': [0,1,1,0,1,0,0,1,0,0,0,1,0,0,1,0,0,1,0,0,1,0,0,0,1,1,1,1],
      '3': [0,1,1,0,1,0,0,1,0,0,0,1,0,1,1,0,0,0,0,1,1,0,0,1,0,1,1,0],
      '4': [1,0,0,1,1,0,0,1,1,0,0,1,1,1,1,1,0,0,0,1,0,0,0,1,0,0,0,1],
      '5': [1,1,1,1,1,0,0,0,1,0,0,0,1,1,1,0,0,0,0,1,1,0,0,1,0,1,1,0],
      '6': [0,1,1,0,1,0,0,0,1,0,0,0,1,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0],
      '7': [1,1,1,1,0,0,0,1,0,0,1,0,0,0,1,0,0,1,0,0,0,1,0,0,0,1,0,0],
      '8': [0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,0],
      '9': [0,1,1,0,1,0,0,1,1,0,0,1,0,1,1,1,0,0,0,1,0,0,0,1,0,1,1,0]
    };

    const MONTHS_EN = ['January','February','March','April','May','June','July','August','September','October','November','December'];
    const MONTHS_EN_SHORT = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const DAYS_EN = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    const DAYS_EN_SHORT = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

    const MONTHS_NL = ['januari','februari','maart','april','mei','juni','juli','augustus','september','oktober','november','december'];
    const MONTHS_NL_SHORT = ['jan','feb','mrt','apr','mei','jun','jul','aug','sep','okt','nov','dec'];
    const DAYS_NL = ['zondag','maandag','dinsdag','woensdag','donderdag','vrijdag','zaterdag'];
    const DAYS_NL_SHORT = ['zo','ma','di','wo','do','vr','za'];

    const ROMAN = ['XII', 'I', 'II', 'III', 'IV', 'V', 'VI', 'VII', 'VIII', 'IX', 'X', 'XI'];

    // ========================
    // STATE
    // ========================
    let Homey;
    let settings = {};
    let locale = 'en';
    let updateTimer;
    let lastFlipValues = {};

    // ========================
    // HELPERS
    // ========================
    const pad = n => String(n).padStart(2, '0');

    function getTimeData() {
      const now = new Date();
      let h = now.getHours();
      const m = now.getMinutes();
      const s = now.getSeconds();
      let period = '';

      if (settings.hourFormat === '12') {
        period = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
      }

      return { h, m, s, period, rawH: now.getHours() };
    }

    function formatTime(data) {
      const colonClass = 'colon-char';
      let str = `${pad(data.h)}<span class="${colonClass}">:</span>${pad(data.m)}`;
      if (settings.showSeconds) str += `<span class="${colonClass}">:</span>${pad(data.s)}`;
      if (data.period) str += ` ${data.period}`;
      return str;
    }

    function formatTimeNoSeconds(data) {
      const colonClass = 'colon-char';
      let str = `${pad(data.h)}<span class="${colonClass}">:</span>${pad(data.m)}`;
      if (data.period) str += ` ${data.period}`;
      return str;
    }

    function getDateData() {
      const now = new Date();
      return {
        day: now.getDate(),
        month: now.getMonth(),
        year: now.getFullYear(),
        weekday: now.getDay(),
        date: now
      };
    }

    function formatDate(data) {
      const isNL = locale === 'nl';
      const months = isNL ? MONTHS_NL : MONTHS_EN;
      const monthsShort = isNL ? MONTHS_NL_SHORT : MONTHS_EN_SHORT;
      const days = isNL ? DAYS_NL : DAYS_EN;
      const daysShort = isNL ? DAYS_NL_SHORT : DAYS_EN_SHORT;
      const fmt = settings.dateFormat || 'weekday-short';

      switch (fmt) {
        case 'dmy': return `${pad(data.day)}/${pad(data.month + 1)}/${data.year}`;
        case 'mdy': return `${pad(data.month + 1)}/${pad(data.day)}/${data.year}`;
        case 'ymd': return `${data.year}-${pad(data.month + 1)}-${pad(data.day)}`;
        case 'long': return isNL ? `${data.day} ${months[data.month]} ${data.year}` : `${months[data.month]} ${data.day}, ${data.year}`;
        case 'short': return isNL ? `${data.day} ${monthsShort[data.month]} ${data.year}` : `${monthsShort[data.month]} ${data.day}, ${data.year}`;
        case 'weekday-long': return isNL ? `${days[data.weekday]} ${data.day} ${months[data.month]}` : `${days[data.weekday]}, ${months[data.month]} ${data.day}`;
        case 'weekday-short': return isNL ? `${daysShort[data.weekday]} ${data.day} ${monthsShort[data.month]}` : `${daysShort[data.weekday]}, ${monthsShort[data.month]} ${data.day}`;
        case 'weekday-only': return days[data.weekday];
        case 'day-month': return isNL ? `${data.day} ${months[data.month]}` : `${months[data.month]} ${data.day}`;
        case 'relative': return getRelativeDate(data.date, isNL, days, monthsShort);
        default: return `${pad(data.day)}/${pad(data.month + 1)}/${data.year}`;
      }
    }

    function getRelativeDate(date, isNL, days, monthsShort) {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const compare = new Date(date);
      compare.setHours(0, 0, 0, 0);
      const diff = Math.round((compare - today) / 86400000);

      if (diff === 0) return isNL ? 'Vandaag' : 'Today';
      if (diff === 1) return isNL ? 'Morgen' : 'Tomorrow';
      if (diff === -1) return isNL ? 'Gisteren' : 'Yesterday';
      
      return isNL 
        ? `${days[date.getDay()]} ${date.getDate()} ${monthsShort[date.getMonth()]}`
        : `${days[date.getDay()]}, ${monthsShort[date.getMonth()]} ${date.getDate()}`;
    }

    function getLayoutSeparator() {
      const layout = settings.layout || 'stacked';
      if (layout === 'inline-separator') return '<span class="layout-separator">|</span>';
      if (layout === 'inline-dot') return '<span class="layout-separator">â€¢</span>';
      return '';
    }

    // ========================
    // RENDERERS
    // ========================
    function renderText() {
      const display = document.getElementById('display');
      const mode = settings.displayMode || 'time';
      const layout = settings.layout || 'stacked';
      const timeData = getTimeData();
      const dateData = getDateData();

      if (mode === 'time') {
        display.innerHTML = `<div class="time-text">${formatTime(timeData)}</div>`;
      } else if (mode === 'date') {
        display.innerHTML = `<div class="date-text">${formatDate(dateData)}</div>`;
      } else {
        const sep = getLayoutSeparator();
        display.innerHTML = `
          <div class="display-container layout-${layout}">
            <div class="time-text">${formatTime(timeData)}</div>
            ${sep}
            <div class="date-text">${formatDate(dateData)}</div>
          </div>
        `;
      }
    }

    function createFlipCard(id, currentVal, prevVal) {
      const shouldFlip = prevVal !== undefined && prevVal !== currentVal;
      return `
        <div class="flip-card ${shouldFlip ? 'flipping' : ''}" data-flip-id="${id}">
          <div class="flip-top flip-face"><span class="flip-digit">${currentVal}</span></div>
          <div class="flip-bottom flip-face"><span class="flip-digit">${currentVal}</span></div>
          ${shouldFlip ? `
            <div class="flip-top-back flip-face"><span class="flip-digit">${prevVal}</span></div>
            <div class="flip-bottom-back flip-face"><span class="flip-digit">${currentVal}</span></div>
          ` : ''}
        </div>
      `;
    }

    function renderFlip() {
      const display = document.getElementById('display');
      const mode = settings.displayMode || 'time';
      const layout = settings.layout || 'stacked';
      const timeData = getTimeData();
      const dateData = getDateData();

      if (mode === 'date') {
        display.innerHTML = `<div class="date-text">${formatDate(dateData)}</div>`;
        return;
      }

      const h = pad(timeData.h);
      const m = pad(timeData.m);
      const s = pad(timeData.s);

      const currentValues = { h0: h[0], h1: h[1], m0: m[0], m1: m[1], s0: s[0], s1: s[1] };

      let colonClass = settings.blinkSeparator ? 'flip-sep colon-char' : 'flip-sep';

      let clock = `<div class="flip-clock">
        <div class="flip-group">
          ${createFlipCard('h0', currentValues.h0, lastFlipValues.h0)}
          ${createFlipCard('h1', currentValues.h1, lastFlipValues.h1)}
        </div>
        <span class="${colonClass}">:</span>
        <div class="flip-group">
          ${createFlipCard('m0', currentValues.m0, lastFlipValues.m0)}
          ${createFlipCard('m1', currentValues.m1, lastFlipValues.m1)}
        </div>`;

      if (settings.showSeconds) {
        clock += `<span class="${colonClass}">:</span>
          <div class="flip-group">
            ${createFlipCard('s0', currentValues.s0, lastFlipValues.s0)}
            ${createFlipCard('s1', currentValues.s1, lastFlipValues.s1)}
          </div>`;
      }

      if (timeData.period) {
        clock += `<span class="flip-period">${timeData.period}</span>`;
      }

      clock += '</div>';

      if (mode === 'datetime') {
        const sep = getLayoutSeparator();
        display.innerHTML = `
          <div class="display-container layout-${layout}">
            ${clock}
            ${sep}
            <div class="date-text">${formatDate(dateData)}</div>
          </div>
        `;
      } else {
        display.innerHTML = clock;
      }

      // Store current values for next comparison
      lastFlipValues = { ...currentValues };

      // Remove flipping class after animation
      setTimeout(() => {
        document.querySelectorAll('.flip-card.flipping').forEach(el => {
          el.classList.remove('flipping');
          // Remove the animation panels
          const topBack = el.querySelector('.flip-top-back');
          const bottomBack = el.querySelector('.flip-bottom-back');
          if (topBack) topBack.remove();
          if (bottomBack) bottomBack.remove();
        });
      }, 500);
    }

    function renderDots() {
      const display = document.getElementById('display');
      const mode = settings.displayMode || 'time';
      const layout = settings.layout || 'stacked';
      const timeData = getTimeData();
      const dateData = getDateData();

      if (mode === 'date') {
        display.innerHTML = `<div class="date-text">${formatDate(dateData)}</div>`;
        return;
      }

      const createDigit = d => {
        const p = DIGIT_PATTERNS[d] || DIGIT_PATTERNS['0'];
        return `<div class="dot-digit">${p.map(v => `<div class="dot${v ? ' on' : ''}"></div>`).join('')}</div>`;
      };

      const h = pad(timeData.h);
      const m = pad(timeData.m);
      const s = pad(timeData.s);

      let dots = `<div class="dots-display">
        ${createDigit(h[0])}${createDigit(h[1])}
        <div class="dot-colon"><div class="dot"></div><div class="dot"></div></div>
        ${createDigit(m[0])}${createDigit(m[1])}`;

      if (settings.showSeconds) {
        dots += `<div class="dot-colon"><div class="dot"></div><div class="dot"></div></div>
          ${createDigit(s[0])}${createDigit(s[1])}`;
      }

      dots += '</div>';

      if (mode === 'datetime') {
        const sep = getLayoutSeparator();
        display.innerHTML = `
          <div class="display-container layout-${layout}">
            ${dots}
            ${sep}
            <div class="date-text">${formatDate(dateData)}</div>
          </div>
        `;
      } else {
        display.innerHTML = dots;
      }
    }

    function updateDots() {
      const timeData = getTimeData();
      const h = pad(timeData.h);
      const m = pad(timeData.m);
      const s = pad(timeData.s);
      const digits = [h[0], h[1], m[0], m[1]];
      if (settings.showSeconds) digits.push(s[0], s[1]);

      const els = document.querySelectorAll('.dot-digit');
      els.forEach((el, i) => {
        const pattern = DIGIT_PATTERNS[digits[i]] || DIGIT_PATTERNS['0'];
        const dots = el.querySelectorAll('.dot');
        dots.forEach((dot, j) => dot.classList.toggle('on', pattern[j] === 1));
      });
    }

    function createAnalogClock(timeData, analogStyle, showSeconds) {
      const h = timeData.rawH % 12;
      const m = timeData.m;
      const s = timeData.s;

      const hDeg = h * 30 + m * 0.5;
      const mDeg = m * 6;
      const sDeg = s * 6;

      let markers = '';

      if (analogStyle === 'classic' || analogStyle === 'vintage') {
        for (let i = 0; i < 12; i++) {
          markers += `<div class="analog-marker" style="transform: rotate(${i * 30}deg)"></div>`;
        }
      } else if (analogStyle === 'minimal') {
        for (let i = 0; i < 4; i++) {
          markers += `<div class="analog-marker" style="transform: rotate(${i * 90}deg)"></div>`;
        }
      } else if (analogStyle === 'roman') {
        for (let i = 0; i < 12; i++) {
          const angle = (i * 30 - 90) * Math.PI / 180;
          const r = 38;
          const x = 50 + r * Math.cos(angle);
          const y = 50 + r * Math.sin(angle);
          markers += `<span class="roman-numeral" style="left:${x}%;top:${y}%;transform:translate(-50%,-50%)">${ROMAN[i]}</span>`;
        }
      } else if (analogStyle === 'modern') {
        for (let i = 0; i < 12; i++) {
          const isQuarter = i % 3 === 0;
          markers += `<div class="analog-marker ${isQuarter ? 'marker-quarter' : 'marker-hour'}" style="transform: rotate(${i * 30}deg)"></div>`;
        }
      } else if (analogStyle === 'swiss') {
        for (let i = 0; i < 60; i++) {
          const isHour = i % 5 === 0;
          markers += `<div class="analog-marker ${isHour ? 'marker-hour' : 'marker-minute'}" style="transform: rotate(${i * 6}deg)"></div>`;
        }
      }

      return `
        <div class="analog-clock analog-${analogStyle}">
          <div class="analog-face">
            ${markers}
            <div class="analog-hand hand-hour" style="transform: rotate(${hDeg}deg)"></div>
            <div class="analog-hand hand-minute" style="transform: rotate(${mDeg}deg)"></div>
            ${showSeconds ? `<div class="analog-hand hand-second" style="transform: rotate(${sDeg}deg)"></div>` : ''}
            <div class="analog-center"></div>
          </div>
        </div>
      `;
    }

    function renderAnalog() {
      const display = document.getElementById('display');
      const mode = settings.displayMode || 'time';
      const layout = settings.layout || 'stacked';
      const analogStyle = settings.analogStyle || 'classic';
      const timeData = getTimeData();
      const dateData = getDateData();

      if (mode === 'date') {
        display.innerHTML = `<div class="date-text">${formatDate(dateData)}</div>`;
        return;
      }

      const clock = createAnalogClock(timeData, analogStyle, settings.showSeconds);

      if (mode === 'datetime') {
        const sep = getLayoutSeparator();
        display.innerHTML = `
          <div class="display-container layout-${layout}">
            ${clock}
            ${sep}
            <div class="date-text">${formatDate(dateData)}</div>
          </div>
        `;
      } else {
        display.innerHTML = clock;
      }
    }

    function updateAnalog() {
      const timeData = getTimeData();
      const h = timeData.rawH % 12;
      const m = timeData.m;
      const s = timeData.s;

      const hHand = document.querySelector('.hand-hour');
      const mHand = document.querySelector('.hand-minute');
      const sHand = document.querySelector('.hand-second');

      if (hHand) hHand.style.transform = `rotate(${h * 30 + m * 0.5}deg)`;
      if (mHand) mHand.style.transform = `rotate(${m * 6}deg)`;
      if (sHand) sHand.style.transform = `rotate(${s * 6}deg)`;
    }

    function renderHybrid() {
      const display = document.getElementById('display');
      const mode = settings.displayMode || 'time';
      const layout = settings.layout || 'stacked';
      const analogStyle = settings.analogStyle || 'classic';
      const timeData = getTimeData();
      const dateData = getDateData();

      if (mode === 'date') {
        display.innerHTML = `<div class="date-text">${formatDate(dateData)}</div>`;
        return;
      }

      // Create small analog clock for seconds only
      const s = timeData.s;
      const sDeg = s * 6;

      const miniClock = `
        <div class="analog-clock analog-minimal">
          <div class="analog-face">
            <div class="analog-hand hand-second" style="transform: rotate(${sDeg}deg)"></div>
            <div class="analog-center"></div>
          </div>
        </div>
      `;

      const hybrid = `
        <div class="hybrid-clock">
          <div class="time-text">${formatTimeNoSeconds(timeData)}</div>
          ${miniClock}
        </div>
      `;

      if (mode === 'datetime') {
        const sep = getLayoutSeparator();
        display.innerHTML = `
          <div class="display-container layout-${layout}">
            ${hybrid}
            ${sep}
            <div class="date-text">${formatDate(dateData)}</div>
          </div>
        `;
      } else {
        display.innerHTML = hybrid;
      }
    }

    function updateHybrid() {
      const timeData = getTimeData();
      const s = timeData.s;
      const m = timeData.m;
      const h = timeData.h;

      // Update digital time
      const timeText = document.querySelector('.hybrid-clock .time-text');
      if (timeText) {
        timeText.innerHTML = formatTimeNoSeconds(timeData);
      }

      // Update analog seconds
      const sHand = document.querySelector('.hand-second');
      if (sHand) sHand.style.transform = `rotate(${s * 6}deg)`;
    }

    function renderAnalogDigital() {
      const display = document.getElementById('display');
      const mode = settings.displayMode || 'time';
      const layout = settings.layout || 'stacked';
      const analogStyle = settings.analogStyle || 'classic';
      const timeData = getTimeData();
      const dateData = getDateData();

      if (mode === 'date') {
        display.innerHTML = `<div class="date-text">${formatDate(dateData)}</div>`;
        return;
      }

      // Create analog clock
      const analogClock = createAnalogClock(timeData, analogStyle, settings.showSeconds);

      // Digital time without seconds
      const digitalTime = `<div class="time-text">${formatTimeNoSeconds(timeData)}</div>`;

      const combo = `
        <div class="hybrid-clock">
          ${analogClock}
          ${digitalTime}
        </div>
      `;

      if (mode === 'datetime') {
        const sep = getLayoutSeparator();
        display.innerHTML = `
          <div class="display-container layout-${layout}">
            ${combo}
            ${sep}
            <div class="date-text">${formatDate(dateData)}</div>
          </div>
        `;
      } else {
        display.innerHTML = combo;
      }
    }

    function updateAnalogDigital() {
      const timeData = getTimeData();
      const h = timeData.rawH % 12;
      const m = timeData.m;
      const s = timeData.s;

      // Update analog hands
      const hHand = document.querySelector('.hand-hour');
      const mHand = document.querySelector('.hand-minute');
      const sHand = document.querySelector('.hand-second');

      if (hHand) hHand.style.transform = `rotate(${h * 30 + m * 0.5}deg)`;
      if (mHand) mHand.style.transform = `rotate(${m * 6}deg)`;
      if (sHand) sHand.style.transform = `rotate(${s * 6}deg)`;

      // Update digital time
      const timeText = document.querySelector('.hybrid-clock .time-text');
      if (timeText) {
        timeText.innerHTML = formatTimeNoSeconds(timeData);
      }
    }

    // ========================
    // HEIGHT CALCULATION
    // ========================
    function calcHeight() {
      const style = settings.style || 'modern';
      const size = settings.size || 'medium';
      const mode = settings.displayMode || 'time';
      const layout = settings.layout || 'stacked';

      const base = { small: 44, medium: 58, large: 76 };
      const special = {
        flip: { small: 48, medium: 64, large: 80 },
        dots: { small: 64, medium: 82, large: 104 },
        analog: { small: 76, medium: 96, large: 120 },
        hybrid: { small: 48, medium: 62, large: 80 },
        'analog-digital': { small: 76, medium: 96, large: 120 }
      };

      let h = (special[style]?.[size]) || base[size];

      const isInline = layout.startsWith('inline');
      if (mode === 'datetime' && !isInline) {
        const dateAdd = { small: 16, medium: 22, large: 28 };
        if (layout === 'compact') {
          h += dateAdd[size] * 0.6;
        } else {
          h += dateAdd[size];
        }
      }

      return h;
    }

    // ========================
    // MAIN RENDER
    // ========================
    function render() {
      const widget = document.getElementById('widget');
      const style = settings.style || 'modern';
      const size = settings.size || 'medium';
      const color = settings.color || 'default';
      const mode = settings.displayMode || 'time';
      const dateSize = settings.dateSize || 'small';
      const align = settings.alignment || 'center';
      const transparent = settings.transparentBackground === true;
      const blinkColon = settings.blinkSeparator === true;

      // Build classes
      const classes = [
        'widget',
        `style-${style}`,
        `size-${size}`,
        `color-${color}`,
        `mode-${mode}`,
        `date-size-${dateSize}`,
        `align-${align}`
      ];

      if (!transparent) classes.push('bg-solid');
      if (blinkColon) classes.push('blink-separator');

      widget.className = classes.join(' ');

      // Set height
      const height = calcHeight();
      Homey?.setHeight?.(height);

      // Reset flip values when style changes
      if (style !== 'flip') {
        lastFlipValues = {};
      }

      // Render based on style
      switch (style) {
        case 'flip':
          renderFlip();
          break;
        case 'dots':
          renderDots();
          break;
        case 'analog':
          renderAnalog();
          break;
        case 'hybrid':
          renderHybrid();
          break;
        case 'analog-digital':
          renderAnalogDigital();
          break;
        default:
          renderText();
      }

      // Setup update timer
      if (updateTimer) clearInterval(updateTimer);

      const updateFn = () => {
        switch (style) {
          case 'flip': renderFlip(); break;
          case 'dots': updateDots(); break;
          case 'analog': updateAnalog(); break;
          case 'hybrid': updateHybrid(); break;
          case 'analog-digital': updateAnalogDigital(); break;
          default: renderText();
        }
      };

      updateTimer = setInterval(updateFn, 1000);
    }

    // ========================
    // INIT
    // ========================
    window.onHomeyReady = homey => {
      Homey = homey;
      settings = Homey.getSettings() || {};

      try {
        locale = Homey.getLanguage?.() || 'en';
      } catch (e) {
        locale = 'en';
      }

      render();

      const height = calcHeight();
      Homey.ready({ height });

      Homey.on('settings', newSettings => {
        settings = newSettings;
        render();
      });
    };
  </script>
</body>
</html>

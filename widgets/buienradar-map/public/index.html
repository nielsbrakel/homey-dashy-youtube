<!DOCTYPE html>
<html>

<head>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: transparent;
        }

        .map-container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            overflow: hidden;
        }

        .map-container iframe {
            border: none;
            display: block;
        }

        .error-message {
            color: var(--homey-text-color, #333);
            font-family: var(--homey-font-family, -apple-system, BlinkMacSystemFont, sans-serif);
            text-align: center;
            padding: 16px;
        }
    </style>
</head>

<body>
    <div id="map-container" class="map-container"></div>

    <script type="text/javascript">
        let currentSettings = {};

        function getZoomValue(zoomLevel) {
            const map = {
                'land': '1',
                'provincia': '2',
                'regio': '3',
                'stad': '4'
            };
            return map[zoomLevel] || '2';
        }

        function getSizeConfig(widgetSize) {
            const sizes = {
                'small': { size: '1', width: 120, height: 220 },
                'medium': { size: '2a', width: 256, height: 256 },
                'large': { size: '2b', width: 330, height: 330 },
                'xlarge': { size: '3', width: 550, height: 512 }
            };
            return sizes[widgetSize] || sizes.medium;
        }

        function buildIframeUrl(sizeConfig) {
            const baseUrl = 'https://gadgets.buienradar.nl/gadget/zoommap/';
            const location = currentSettings.location || 'Amsterdam';
            const zoomValue = getZoomValue(currentSettings.zoomLevel || 'provincia');
            const timePeriod = currentSettings.timePeriod || '0';
            const showName = currentSettings.showName !== false ? '2' : '0';

            const params = new URLSearchParams();
            params.append('naam', location);
            params.append('zoom', zoomValue);
            params.append('size', sizeConfig.size);
            params.append('voor', timePeriod);
            params.append('overname', showName);

            return `${baseUrl}?${params.toString()}`;
        }

        function calculateHeight(sizeConfig) {
            // Return the appropriate height for this size
            return sizeConfig.height + 16; // Add padding
        }

        function render(Homey) {
            const container = document.getElementById('map-container');
            const sizeConfig = getSizeConfig(currentSettings.widgetSize || 'medium');
            const iframeUrl = buildIframeUrl(sizeConfig);

            const iframe = document.createElement('iframe');
            iframe.src = iframeUrl;
            iframe.setAttribute('scrolling', 'NO');
            iframe.setAttribute('frameborder', '0');
            iframe.setAttribute('width', sizeConfig.width);
            iframe.setAttribute('height', sizeConfig.height);
            iframe.setAttribute('allowtransparency', 'true');

            container.innerHTML = '';
            container.appendChild(iframe);

            // Set widget height to match content
            if (Homey && typeof Homey.setHeight === 'function') {
                Homey.setHeight(calculateHeight(sizeConfig));
            }
        }

        async function onHomeyReady(Homey) {
            currentSettings = Homey.getSettings();

            const sizeConfig = getSizeConfig(currentSettings.widgetSize || 'medium');

            render(null);

            Homey.on('settings.set', (key, value) => {
                currentSettings[key] = value;
                render(Homey);
            });

            Homey.ready({ height: calculateHeight(sizeConfig) });
        }
    </script>
</body>

</html>
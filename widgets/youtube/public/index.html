<html>

<head>
  <style>
    .youtube-container iframe {
      border: none;
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="youtube-container" class="youtube-container">
  </div>

  <script type="text/javascript">
    // State of the widget
    let currentSettings = {};

    function getAspectRatioPercentage(aspectRatio) {
      const ratios = {
        '1:1': '100%',
        '4:3': '75%',
        '16:9': '56.25%',
        '9:16': '177.78%',
        '21:9': '42.86%',
        '3:1': '33.33%'
      };
      return ratios[aspectRatio];
    }

    function buildIframeUrl() {
      const baseUrl = 'https://www.youtube-nocookie.com/embed';
      const playlistId = currentSettings.playlistId.trim();
      const videoId = currentSettings.videoId.trim();

      const params = new URLSearchParams();

      // If playlist is specified, use playlist mode
      let url;
      if (playlistId) {
        url = `${baseUrl}/videoseries`;
        params.append('list', playlistId);
      } else {
        url = `${baseUrl}/${videoId}`;
      }

      if (currentSettings.autoplay) {
        params.append('autoplay', '1');
      }
      if (currentSettings.mute) {
        params.append('mute', '1');
      }
      if (!currentSettings.controls) {
        params.append('controls', '0');
      }
      if (currentSettings.loop) {
        params.append('loop', '1');
      }
      if (currentSettings.start > 0) {
        params.append('start', String(currentSettings.start));
      }

      params.append('fs', '1');

      const queryString = params.toString();
      return `${url}${queryString ? '?' + queryString : ''}`;
    }

    function render() {
      const content = document.getElementById('youtube-container');

      const iframeUrl = buildIframeUrl();

      const iframe = document.createElement('iframe');
      iframe.src = iframeUrl;
      iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
      iframe.allowFullscreen = true;

      content.innerHTML = '';
      content.appendChild(iframe);
    }

    async function onHomeyReady(Homey) {
      currentSettings = Homey.getSettings();
      const heightPercentage = getAspectRatioPercentage(currentSettings.aspectRatio);
      render();

      Homey.ready({ height: heightPercentage });
    }
  </script>
</body>

</html>